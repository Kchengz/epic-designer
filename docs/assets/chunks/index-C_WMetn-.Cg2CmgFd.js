import{d as Y,j as _,N as D,h as P,k as xe,o as R,c as z,I as V,w as te,l as N,P as ne,x as H,ai as ue,aj as ce,m as u,t as Ce,e as ve,n as q,F as G,ak as Ne,Z as _e,z as Ee,E as Se,b as ee,al as Te,D as de,G as Ie,R as he,r as Re,M as $e,am as fe}from"./framework.Bj7ZzXMq.js";import{u as me,z as A,O as Be,j as Ve,Y as De,e as Le,X as je,A as re,t as Oe,Z as ge,H as ze,E as J,a as se,n as Ae,Q as Pe}from"./index-dBLYGWys.BhaKRvQG.js";import{m as ae}from"./icon.vue_vue_type_script_setup_true_lang-BKjDMfHm.B7qh1Z_7.js";import{R as Me}from"./vuedraggable.umd-Bo-O9gJ9.DAQiaosd.js";import"./commonjsHelpers-CT_km90n.D7mXbCtF.js";const Fe={class:"epic-widget-action-item whitespace-nowrap"},Je={key:0,class:"flex"},Ue=Y({__name:"previewWidgets",setup(M,{expose:T}){const x=D("pageManager",{}),f=D("pageSchema"),c=D("designer"),d=D("designerProps"),a=_(null),y=_(null),w=_(null),I=_(!1),s=_(!1),m=_(!0),o=_("top"),{canvasScale:r,disabledZoom:v}=me();let n=null;const j=P(()=>{const l=c.state.checkedNode;return!(!(l!=null&&l.id)||d.value.lockDefaultSchemaEdit&&x.defaultComponentIds.value.includes(l==null?void 0:l.id))}),B=P(()=>{var l,g,p,k,b,C;const E=x.componentInstances.value,h=(l=c.state.checkedNode)==null?void 0:l.id;if((p=(g=c.state.checkedNode)==null?void 0:g.componentProps)!=null&&p.hidden)return null;const O=A.getComponentConfingByType((k=c.state.checkedNode)==null?void 0:k.type)??null;if(!h||!(E!=null&&E[h]))return null;if(O!=null&&O.defaultSchema.input&&((b=c.state.checkedNode)==null?void 0:b.noFormItem)!==!0)return(C=E[h+"formItem"])==null?void 0:C.$el;const S=E[h];return!(S!=null&&S.$el)||(S==null?void 0:S.$el.nodeName)==="#text"||!(S!=null&&S.$el.getBoundingClientRect)?null:S==null?void 0:S.$el}),$=P(()=>{var l,g,p,k;const b=x.componentInstances.value,C=(l=c.state.hoverNode)==null?void 0:l.id,E=A.getComponentConfingByType((g=c.state.hoverNode)==null?void 0:g.type)??null;if(!C||!(b!=null&&b[C]))return null;if(E!=null&&E.defaultSchema.input&&((p=c.state.hoverNode)==null?void 0:p.noFormItem)!==!0)return(k=b[C+"formItem"])==null?void 0:k.$el;const h=b[C];return(h==null?void 0:h.$el.nodeName)==="#text"?null:h==null?void 0:h.$el}),{mutationObserver:L,observerConfig:K}=pe(Z),{startTimedQuery:W,stopTimedQuery:U}=Oe(Z);H(()=>B.value,l=>{if(l){I.value=!0,L.observe(l,K);const g=l.parentNode;g&&(g.ondragstart=()=>{m.value=!1,W()},g.ondragend=()=>{m.value=!0,U()}),Z()}else I.value=!1});const{mutationObserver:X,observerConfig:t}=pe(oe);H(()=>$.value,l=>{l&&(X.observe(l,t),oe())});let e=0;H(()=>{var l;return(l=c.state.hoverNode)==null?void 0:l.id},l=>{if(l){s.value=!0,clearTimeout(e);return}e=setTimeout(()=>{s.value=!1},300)});let i=0,F=0;function Z(){const l=B.value;if(!l||!n)return;const{top:g,left:p}=n==null?void 0:n.getBoundingClientRect(),{top:k,left:b,width:C,height:E}=l.getBoundingClientRect(),h=v.value?1:r.value,O=k-g+((n==null?void 0:n.scrollTop)??0)*h,S=b-p+((n==null?void 0:n.scrollLeft)??0)*h,Q=E/h;a.value&&(a.value.style.width=`${C/h}px`,a.value.style.height=`${Q}px`,a.value.style.top=`${O/h}px`,a.value.style.left=`${S/h}px`,le(O,S)),w.value&&(O<45&&Q<100?(w.value.style.top="",w.value.style.bottom="-30px",w.value.style["border-radius"]="0px 0px 4px 4px",o.value="bottom"):O<45?(w.value.style.top="0px",w.value.style["border-radius"]="0px 0px 4px 0",o.value="center"):(w.value.style.top="-30px",w.value.style["border-radius"]="4px 4px 0px 0px",o.value="top"))}function le(l,g){const p=B.value;if(!n||!p)return;const k=n.getBoundingClientRect(),{width:b}=p.getBoundingClientRect(),C=v.value?1:r.value,E=l/C-k.top;let h=g/C-k.left+b/C;h<k.width&&(h=0);const O=n.scrollTop-k.height/3+60,S=n.scrollTop+k.height/3*2,Q=n.scrollLeft-k.width+200,ie=n.scrollLeft+k.width-200;Math.abs(E-i)<10&&Math.abs(h-F)<10||(i=E,F=h,!(E>O&&E<S&&h>Q&&h<ie)&&(n.scrollTop=E,n.scrollLeft=h))}function oe(){var l,g;const p=$.value;if(!p)return;const{top:k,left:b}=(n==null?void 0:n.getBoundingClientRect())??{top:0,left:0},{top:C,left:E,width:h,height:O}=((l=p.getBoundingClientRect)==null?void 0:l.call(p))??((g=p.nextElementSibling)==null?void 0:g.getBoundingClientRect()),S=v.value?1:r.value,Q=C-k+((n==null?void 0:n.scrollTop)??0)*S,ie=E-b+((n==null?void 0:n.scrollLeft)??0)*S;y.value&&(y.value.style.width=`${h/S}px`,y.value.style.height=`${O/S}px`,y.value.style.top=`${Q/S}px`,y.value.style.left=`${ie/S}px`)}function pe(l){const g=window.MutationObserver,p={childList:!0,attributes:!0,subtree:!0};return{mutationObserver:new g(l),observerConfig:p}}function ke(){var l;const g=ge(f.schemas,((l=c.state.checkedNode)==null?void 0:l.id)??"root");if(!g)return!1;const{list:p,schema:k,index:b}=g,C=ze(k);p.splice(b+1,0,C),c.setCheckedNode(C),J.push(f.schemas,"复制组件")}function be(){var l;const g=ge(f.schemas,((l=c.state.checkedNode)==null?void 0:l.id)??"root");if(!g)return!1;let{list:p,schema:k,index:b}=g;p.splice(b,1),b===p.length&&b--,c.setCheckedNode(p[b]),J.push(f.schemas,"删除组件")}function we(l){n=l,n==null||n.addEventListener("scroll",()=>{Z()}),re(B,Z),re($,oe)}return T({handleInit:we}),(l,g)=>{var p,k,b,C,E;return R(),z(G,null,[ue(N("div",{ref_key:"selectorRef",ref:a,class:q(["epic-checked-widget absolute pointer-events-none z-20",o.value+" "+(m.value?"transition-all":"")])},[N("div",{class:"epic-widget-action-box",ref_key:"actionBoxRef",ref:w},[N("div",Fe,Ce((k=u(A).getComponentConfingByType(((p=u(c).state.checkedNode)==null?void 0:p.type)??""))==null?void 0:k.defaultSchema.label),1),j.value?(R(),z("div",Je,[N("div",{title:"复制",class:"epic-widget-action-item pointer-events-auto",onClick:ke},[V(u(ae),{name:"icon-fuzhi3"})]),N("div",{title:"删除",class:"epic-widget-action-item pointer-events-auto",onClick:be},[V(u(ae),{name:"icon-shanchu1"})])])):ve("",!0)],512)],2),[[ce,I.value&&((b=u(c).state.checkedNode)==null?void 0:b.id)!=="root"]]),ue(N("div",{ref_key:"hoverWidgetRef",ref:y,class:"epic-hover-widget absolute transition-all pointer-events-none z-998"},null,512),[[ce,s.value&&((C=u(c).state.checkedNode)==null?void 0:C.id)!==((E=u(c).state.hoverNode)==null?void 0:E.id)]])],64)}}}),Ze=Y({name:"EditNodeItem",__name:"editNodeItem",props:{schemas:{}},emits:["update:schemas"],setup(M,{emit:T}){const x=D("designer"),f=D("pageSchema"),c=M,d=T,a=P({get(){return c.schemas},set(m){d("update:schemas",m)}});function y(m){x.setCheckedNode(a.value[m]),x.setDisableHover(!0)}function w(){x.setDisableHover(),J.push(f.schemas,"拖拽组件")}function I(){J.push(f.schemas,"插入组件")}function s(m){return m.type==="page"||A.getComponentConfingByType(m.type).immovable?"unmover-item":"draggable-item"}return(m,o)=>(R(),ee(u(Me),$e({modelValue:a.value,"onUpdate:modelValue":o[0]||(o[0]=r=>a.value=r),"item-key":"id","component-data":{type:"transition-group"},class:"epic-draggable-range"},{animation:200,group:"edit-draggable",handle:".draggable-item",ghostClass:"moveing"},{onStart:o[1]||(o[1]=r=>y(r.oldIndex)),onEnd:o[2]||(o[2]=r=>w()),onAdd:o[3]||(o[3]=r=>{y(r.newIndex),I()})}),{item:te(({element:r,index:v})=>[(R(),z("div",{class:q(["widget-box",s(r)]),key:v},[V(ye,{schema:r},null,8,["schema"])],2))]),_:1},16,["modelValue"]))}}),ye=Y({name:"ENodeItem",__name:"nodeItem",props:{schema:{},name:{}},setup(M){const T=Ne(),x=D("designer"),f=D("pageManager",{}),c=_(null);_e("nodeAttrs",T);const d=M,a=P(()=>{var s,m,o,r,v;const n=f.componentInstances.value,j=(s=d.schema)==null?void 0:s.id,B=A.getComponentConfingByType((m=d.schema)==null?void 0:m.type)??null;if(!j||!(n!=null&&n[j]))return null;if(B!=null&&B.defaultSchema.input&&((o=d.schema)==null?void 0:o.noFormItem)!==!0)return(r=n[j+"formItem"])==null?void 0:r.$el;const $=n[j];return((v=$==null?void 0:$.$el)==null?void 0:v.nodeName)==="#text"?null:$==null?void 0:$.$el});H(()=>a.value,s=>{s==null||s.addEventListener("click",y,!1),s==null||s.addEventListener("mouseover",w,!1),s==null||s.addEventListener("mouseout",I,!1)}),Ee(()=>{var s,m,o;(s=a.value)==null||s.removeEventListener("click",y,!1),(m=a.value)==null||m.removeEventListener("mouseover",w,!1),(o=a.value)==null||o.removeEventListener("mouseout",I,!1)});function y(s){s.stopPropagation(),x.setCheckedNode(d.schema)}function w(s){d.schema.type!=="page"&&(s.stopPropagation(),x.setHoverNode(d.schema))}function I(s){s.stopPropagation(),x.setHoverNode(null)}return(s,m)=>{var o;const r=Se("ENodeItem");return R(),ee(u(Be),{ref_key:"nodeRef",ref:c,componentSchema:d.schema},Te({_:2},[(o=u(A).getComponentConfingByType(d.schema.type))!=null&&o.childImmovable?{name:"edit-node",fn:te(()=>[(R(!0),z(G,null,de(d.schema.children,v=>(R(),ee(r,{key:v.id,schema:v},null,8,["schema"]))),128))]),key:"0"}:{name:"edit-node",fn:te(()=>[d.schema.children?(R(),ee(Ze,{key:0,schemas:d.schema.children,"onUpdate:schemas":m[0]||(m[0]=v=>d.schema.children=v)},null,8,["schemas"])):ve("",!0)]),key:"1"}]),1032,["componentSchema"])}}}),He={class:"min-w-750px rounded h-full"},Ye=Y({__name:"previewJson",setup(M,{expose:T}){const x=A.getComponent("modal"),f=A.getComponent("monacoEditor"),c={theme:"vs-light",selectOnLineNumbers:!0,minimap:{enabled:!1},readOnly:!0},d=_(null),a=_(!1),y=D("pageSchema");function w(){a.value=!1}function I(){a.value=!0,d.value?d.value.setValue(JSON.stringify(y,null,2)):setTimeout(()=>{I()},300)}function s(m="epic-data.json"){let o="data:text/json;charset=utf-8,";o+=JSON.stringify(y,null,2);var r=encodeURI(o),v=document.createElement("a");v.setAttribute("href",r),v.setAttribute("download",m),v.click()}return T({handleOpen:I}),(m,o)=>(R(),ee(u(x),{modelValue:a.value,"onUpdate:modelValue":o[0]||(o[0]=r=>a.value=r),title:"查看数据",class:"w-900px",width:"900px",onClose:w,onOk:s,okText:"导出数据"},{default:te(()=>[N("div",He,[V(u(f),{ref_key:"monacoEditorRef",ref:d,class:"editor h-full",autoToggleTheme:"",config:c,language:"json"},null,512)])]),_:1},8,["modelValue"]))}}),We={class:"epic-edit-toolbar flex items-center justify-between px-4"},Qe={class:"flex-1 h-full flex items-center"},qe=["title","onClick"],Ke={class:"flex-1 h-full flex items-center justify-center"},Xe=["title","onClick"],Ge={class:"flex-1 h-full flex items-center justify-end"},et={key:0,class:"flex items-center ml-12px"},tt={class:"pr-8px w-82px cursor-pointer"},lt={class:"w-90px cursor-pointer"},nt=Y({__name:"toolbar",setup(M){const T=A.getComponent("slider"),x=A.getComponent("select"),{canvasScale:f,disabledZoom:c}=me(),d=_("pc"),a=D("pageSchema"),y=D("designer"),w=_(null),I=[{icon:"icon-a-diannaotoubu",title:"pc",key:"pc"},{icon:"icon-a-pingbantoubu",title:"平板",key:"pad"},{icon:"icon-a-shoujitoubu",title:"手机",key:"mobile"}],s=J.recordList,m=J.undoList,o=P(()=>[{icon:"icon-daima1",title:"查看数据",on:()=>L()},{icon:"icon-shangchuan1",title:"导入数据",on:K},{icon:"icon-shanchu1",title:"清空",on:$},{icon:"icon-chexiao2x",title:"撤销",on:j,disabled:!s.value.length},{icon:"icon-fanhui2x",title:"重做",on:B,disabled:!m.value.length}]),r=_(null),v=P({get(){return`${(f.value*100).toFixed(0)}%`},set(t){f.value=Number(t)}}),n=[{label:"60%",value:"0.6"},{label:"80%",value:"0.8"},{label:"100%",value:"1.0"},{label:"120%",value:"1.2"},{label:"140%",value:"1.4"}];function j(){const t=J.undo();t&&(se(a.schemas,t),y.setCheckedNode(a.schemas[0]))}function B(){const t=J.redo();t&&(se(a.schemas,t),y.setCheckedNode(a.schemas[0]))}function $(){y.reset()}function L(){w.value.handleOpen()}function K(){var t;(t=r.value)==null||t.click()}function W(t){var e;const i=(e=t.target.files)==null?void 0:e[0];if(!i)return;t.target.value=null;const F=new FileReader;F.readAsText(i),F.onload=Z=>{var le;U((le=Z.target)==null?void 0:le.result)}}function U(t){try{let e=JSON.parse(t??"");e.schemas||(e=Pe(e)),se(a,e)}catch(e){console.error(e)}}function X(t){y.handleToggleDeviceMode(t),d.value=t;const e={pc:{},pad:{width:"800px",mode:t},mobile:{width:"420px",mode:t}};a.canvas=e[t]}return(t,e)=>(R(),z(G,null,[N("div",We,[N("div",Qe,[(R(!0),z(G,null,de(o.value,(i,F)=>(R(),z("div",{title:i.title,class:q(["epic-action-item h-90% px-10px flex items-center cursor-pointer",{disabled:i.disabled}]),key:F,onClick:i.on},[V(u(ae),{name:i.icon},null,8,["name"])],10,qe))),128))]),ue(N("input",{type:"file",ref_key:"fileRef",ref:r,accept:".json,.txt",onChange:W},null,544),[[ce,!1]]),N("div",Ke,[(R(),z(G,null,de(I,i=>N("div",{title:i.title,class:q(["epic-device-item h-90% px-10px flex items-center cursor-pointer",{checked:i.key===d.value}]),key:i.key,onClick:F=>X(i.key)},[V(u(ae),{name:i.icon},null,8,["name"])],10,Xe)),64))]),N("div",Ge,[u(c)?ve("",!0):(R(),z("div",et,[N("div",tt,[V(u(x),{value:v.value,"onUpdate:value":e[0]||(e[0]=i=>v.value=i),modelValue:v.value,"onUpdate:modelValue":e[1]||(e[1]=i=>v.value=i),options:n,size:"small"},null,8,["value","modelValue"])]),N("div",lt,[V(u(T),{min:.6,max:1.4,step:.01,tooltip:!1,value:u(f),"onUpdate:value":e[2]||(e[2]=i=>fe(f)?f.value=i:null),modelValue:u(f),"onUpdate:modelValue":e[3]||(e[3]=i=>fe(f)?f.value=i:null)},null,8,["value","modelValue"])])]))])]),V(Ye,{ref_key:"previewJson",ref:w},null,512)],64))}}),at={class:"h-full flex flex-col relative"},ot=["draggable"],it=Y({__name:"editScreenContainer",setup(M){const T=D("pageSchema"),x=_(null),f=_(null),c=_(null),{pressSpace:d,disabledZoom:a}=me(),{handleElementDragStart:y,handleElementDrag:w,handleElementDragEnd:I}=Ve(x),{width:s,height:m}=De(x),{canvasScale:o,handleZoom:r}=Le(f);let v=0,n=0;const j=_({}),B=_({}),$=_({}),L=Ie({width:0,height:0});H(()=>{var t,e;return{width:(t=T.canvas)==null?void 0:t.width,height:(e=T.canvas)==null?void 0:e.height}},W),H($,()=>{he(K)}),xe(()=>{var t,e;W({width:(t=T.canvas)==null?void 0:t.width,height:(e=T.canvas)==null?void 0:e.height})});function K(){const t=u(c);t&&(L.value={width:t.clientWidth,height:t.clientHeight})}function W({width:t,height:e}){$.value={width:t??"0",height:e??"0"}}je(s,U),H(L,U);function U(){if(a.value){B.value={width:v+"px",height:n+"px",transform:"translate(0px, 20px)"};return}let t=L.value.width||v,e=L.value.height||n;j.value={width:s.value+t+"px",height:m.value+e+"px"},B.value={width:t+"px",height:e+"px"},X()}function X(){he(()=>{let t=L.value.width||v;const e=(L.value.height||n)/2,i=t/2;x.value.scrollTo(i,e)})}return re(x,([{contentRect:t}])=>{if(v=t.width-60,n=t.height-80,!a.value)if(L.value.width===0)o.value=1;else{const e=(v-20)/L.value.width;o.value=e<1.2?e:o.value}Ae(U,50)()}),(t,e)=>(R(),z("div",at,[V(nt),N("div",{ref_key:"editScreenContainerRef",ref:x,class:q(["flex-1 overflow-auto overflow-y-hidden epic-edit-screen-container",{"cursor-grab":u(d)}]),draggable:u(d),onWheel:e[0]||(e[0]=(...i)=>u(r)&&u(r)(...i)),onDragstart:e[1]||(e[1]=(...i)=>u(y)&&u(y)(...i)),onDragend:e[2]||(e[2]=(...i)=>u(I)&&u(I)(...i)),onDrag:e[3]||(e[3]=(...i)=>u(w)&&u(w)(...i))},[N("div",{id:"canvasContainer",class:"flex items-center justify-center",style:ne(j.value)},[N("div",{ref_key:"draggableElRef",ref:f,class:"transition-all"},[N("div",{class:q({"pointer-events-none":u(d)}),style:ne(B.value)},[Re(t.$slots,"default")],6)],512)],4)],42,ot),N("div",{ref_key:"sizeBoxRef",ref:c,class:"absolute op-0 pointer-events-none",style:ne($.value)},null,4)]))}}),st={class:"epic-edit-canvas"},mt=Y({__name:"index",setup(M){const T=_(null),x=_(null),f=D("pageSchema"),c=P(()=>f.schemas[0]),d=P(()=>({width:"100%",height:"100%"}));return xe(()=>{var a;(a=x.value)==null||a.handleInit(T.value)}),(a,y)=>(R(),z("section",st,[V(it,null,{default:te(()=>[N("div",{ref_key:"epicEditRangeRef",ref:T,class:"epic-edit-range rounded-md overflow-auto relative",style:ne(d.value)},[V(ye,{schema:c.value},null,8,["schema"]),V(Ue,{ref_key:"ePreviewWidgetsRef",ref:x},null,512)],4)]),_:1})]))}});export{mt as default};
