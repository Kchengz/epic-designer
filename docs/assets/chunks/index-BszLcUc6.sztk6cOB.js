import{d as H,j as _,N as D,h as F,k as xe,o as E,c as P,I as V,w as te,l as N,P as ne,x as Z,ai as ue,aj as ce,m as u,t as Ce,e as ve,n as Y,F as X,ak as Ne,Z as _e,z as $e,E as Te,b as ee,al as Re,D as de,G as Se,R as pe,r as Ee,M as Be,am as fe}from"./framework.C8YhLXwE.js";import{o as me,N as z,c as Ie,R as Ve,P as De,O as Le,_ as je,t as re,V as Oe,A as ge,C as Pe,g as W,K as se,T as Ue,D as ze}from"./index-DZavvwVo.CLpuZ4sn.js";import{m as ae}from"./icon.vue_vue_type_script_setup_true_lang-BKjDMfHm.D0t_j6sh.js";import{R as Fe}from"./vuedraggable.umd-Bo-O9gJ9.CXDJdMaS.js";import"./commonjsHelpers-CT_km90n.D7mXbCtF.js";const Me={class:"epic-widget-action-item whitespace-nowrap"},We={key:0,class:"flex"},Je=H({__name:"previewWidgets",setup(M,{expose:R}){const x=D("pageManager",{}),p=D("pageSchema"),c=D("designer"),d=D("designerProps"),o=_(null),y=_(null),w=_(null),S=_(!1),s=_(!1),v=_(!0),a=_("top"),{canvasScale:r,disabledZoom:f}=me();let l=null;const j=F(()=>{const n=c.state.checkedNode;return!(!(n!=null&&n.id)||d.value.lockDefaultSchemaEdit&&x.defaultComponentIds.value.includes(n==null?void 0:n.id))}),I=F(()=>{var n,g,m,k,b,C;const $=x.componentInstances.value,h=(n=c.state.checkedNode)==null?void 0:n.id;if((m=(g=c.state.checkedNode)==null?void 0:g.componentProps)!=null&&m.hidden)return null;const O=z.getComponentConfingByType((k=c.state.checkedNode)==null?void 0:k.type)??null;if(!h||!($!=null&&$[h]))return null;if(O!=null&&O.defaultSchema.input&&((b=c.state.checkedNode)==null?void 0:b.noFormItem)!==!0)return(C=$[h+"formItem"])==null?void 0:C.$el;const T=$[h];return!(T!=null&&T.$el)||(T==null?void 0:T.$el.nodeName)==="#text"||!(T!=null&&T.$el.getBoundingClientRect)?null:T==null?void 0:T.$el}),B=F(()=>{var n,g,m,k;const b=x.componentInstances.value,C=(n=c.state.hoverNode)==null?void 0:n.id,$=z.getComponentConfingByType((g=c.state.hoverNode)==null?void 0:g.type)??null;if(!C||!(b!=null&&b[C]))return null;if($!=null&&$.defaultSchema.input&&((m=c.state.hoverNode)==null?void 0:m.noFormItem)!==!0)return(k=b[C+"formItem"])==null?void 0:k.$el;const h=b[C];return(h==null?void 0:h.$el.nodeName)==="#text"?null:h==null?void 0:h.$el}),{mutationObserver:L,observerConfig:Q}=he(A),{startTimedQuery:K,stopTimedQuery:J}=Oe(A);Z(()=>I.value,n=>{if(n){S.value=!0,L.observe(n,Q);const g=n.parentNode;g&&(g.ondragstart=()=>{v.value=!1,K()},g.ondragend=()=>{v.value=!0,J()}),A()}else S.value=!1});const{mutationObserver:G,observerConfig:t}=he(oe);Z(()=>B.value,n=>{n&&(G.observe(n,t),oe())});let e=0;Z(()=>{var n;return(n=c.state.hoverNode)==null?void 0:n.id},n=>{if(n){s.value=!0,clearTimeout(e);return}e=setTimeout(()=>{s.value=!1},300)});let i=0,U=0;function A(){const n=I.value;if(!n||!l)return;const{top:g,left:m}=l==null?void 0:l.getBoundingClientRect(),{top:k,left:b,width:C,height:$}=n.getBoundingClientRect(),h=f.value?1:r.value,O=k-g+((l==null?void 0:l.scrollTop)??0)*h,T=b-m+((l==null?void 0:l.scrollLeft)??0)*h,q=$/h;o.value&&(o.value.style.width=`${C/h}px`,o.value.style.height=`${q}px`,o.value.style.top=`${O/h}px`,o.value.style.left=`${T/h}px`,le(O,T)),w.value&&(O<45&&q<100?(w.value.style.top="",w.value.style.bottom="-30px",w.value.style["border-radius"]="0px 0px 4px 4px",a.value="bottom"):O<45?(w.value.style.top="0px",w.value.style["border-radius"]="0px 0px 4px 0",a.value="center"):(w.value.style.top="-30px",w.value.style["border-radius"]="4px 4px 0px 0px",a.value="top"))}function le(n,g){const m=I.value;if(!l||!m)return;const k=l.getBoundingClientRect(),{width:b}=m.getBoundingClientRect(),C=f.value?1:r.value,$=n/C-k.top;let h=g/C-k.left+b/C;h<k.width&&(h=0);const O=l.scrollTop-k.height/3+60,T=l.scrollTop+k.height/3*2,q=l.scrollLeft-k.width+200,ie=l.scrollLeft+k.width-200;Math.abs($-i)<10&&Math.abs(h-U)<10||(i=$,U=h,!($>O&&$<T&&h>q&&h<ie)&&(l.scrollTop=$,l.scrollLeft=h))}function oe(){var n,g;const m=B.value;if(!m)return;const{top:k,left:b}=(l==null?void 0:l.getBoundingClientRect())??{top:0,left:0},{top:C,left:$,width:h,height:O}=((n=m.getBoundingClientRect)==null?void 0:n.call(m))??((g=m.nextElementSibling)==null?void 0:g.getBoundingClientRect()),T=f.value?1:r.value,q=C-k+((l==null?void 0:l.scrollTop)??0)*T,ie=$-b+((l==null?void 0:l.scrollLeft)??0)*T;y.value&&(y.value.style.width=`${h/T}px`,y.value.style.height=`${O/T}px`,y.value.style.top=`${q/T}px`,y.value.style.left=`${ie/T}px`)}function he(n){const g=window.MutationObserver,m={childList:!0,attributes:!0,subtree:!0};return{mutationObserver:new g(n),observerConfig:m}}function ke(){var n;const g=ge(p.schemas,((n=c.state.checkedNode)==null?void 0:n.id)??"root");if(!g)return!1;const{list:m,schema:k,index:b}=g,C=Pe(k);m.splice(b+1,0,C),c.setCheckedNode(C),W.push(p.schemas,"复制组件")}function be(){var n;const g=ge(p.schemas,((n=c.state.checkedNode)==null?void 0:n.id)??"root");if(!g)return!1;let{list:m,schema:k,index:b}=g;m.splice(b,1),b===m.length&&b--,c.setCheckedNode(m[b]),W.push(p.schemas,"删除组件")}function we(n){l=n,l==null||l.addEventListener("scroll",()=>{A()}),re(I,A),re(B,oe)}return R({handleInit:we}),(n,g)=>{var m,k,b,C,$;return E(),P(X,null,[ue(N("div",{ref_key:"selectorRef",ref:o,class:Y(["epic-checked-widget absolute pointer-events-none z-20",a.value+" "+(v.value?"transition-all":"")])},[N("div",{class:"epic-widget-action-box",ref_key:"actionBoxRef",ref:w},[N("div",Me,Ce((k=u(z).getComponentConfingByType(((m=u(c).state.checkedNode)==null?void 0:m.type)??""))==null?void 0:k.defaultSchema.label),1),j.value?(E(),P("div",We,[N("div",{title:"复制",class:"epic-widget-action-item pointer-events-auto",onClick:ke},[V(u(ae),{name:"icon-fuzhi3"})]),N("div",{title:"删除",class:"epic-widget-action-item pointer-events-auto",onClick:be},[V(u(ae),{name:"icon-shanchu1"})])])):ve("",!0)],512)],2),[[ce,S.value&&((b=u(c).state.checkedNode)==null?void 0:b.id)!=="root"]]),ue(N("div",{ref_key:"hoverWidgetRef",ref:y,class:"epic-hover-widget absolute transition-all pointer-events-none z-998"},null,512),[[ce,s.value&&((C=u(c).state.checkedNode)==null?void 0:C.id)!==(($=u(c).state.hoverNode)==null?void 0:$.id)]])],64)}}}),Ae=H({name:"EditNodeItem",__name:"editNodeItem",props:{schemas:{}},emits:["update:schemas"],setup(M,{emit:R}){const x=D("designer"),p=D("pageSchema"),c=M,d=R,o=F({get(){return c.schemas},set(v){d("update:schemas",v)}});function y(v){x.setCheckedNode(o.value[v]),x.setDisableHover(!0)}function w(){x.setDisableHover(),W.push(p.schemas,"拖拽组件")}function S(){W.push(p.schemas,"插入组件")}function s(v){var a;return v.type==="page"||(a=z.getComponentConfingByType(v.type).editConstraints)!=null&&a.immovable?"unmover-item":"draggable-item"}return(v,a)=>(E(),ee(u(Fe),Be({modelValue:o.value,"onUpdate:modelValue":a[0]||(a[0]=r=>o.value=r),"item-key":"id","component-data":{type:"transition-group"},class:"epic-draggable-range"},{animation:200,group:"edit-draggable",handle:".draggable-item",ghostClass:"moveing"},{onStart:a[1]||(a[1]=r=>y(r.oldIndex)),onEnd:a[2]||(a[2]=r=>w()),onAdd:a[3]||(a[3]=r=>{y(r.newIndex),S()})}),{item:te(({element:r,index:f})=>[(E(),P("div",{class:Y(["widget-box",s(r)]),key:f},[V(ye,{schema:r},null,8,["schema"])],2))]),_:1},16,["modelValue"]))}}),ye=H({name:"ENodeItem",__name:"nodeItem",props:{schema:{},name:{}},setup(M){const R=Ne(),x=D("designer"),p=D("pageManager",{}),c=_(null);_e("nodeAttrs",R);const d=M,o=F(()=>{var s,v,a,r,f;const l=p.componentInstances.value,j=(s=d.schema)==null?void 0:s.id,I=z.getComponentConfingByType((v=d.schema)==null?void 0:v.type)??null;if(!j||!(l!=null&&l[j]))return null;if(I!=null&&I.defaultSchema.input&&((a=d.schema)==null?void 0:a.noFormItem)!==!0)return(r=l[j+"formItem"])==null?void 0:r.$el;const B=l[j];return((f=B==null?void 0:B.$el)==null?void 0:f.nodeName)==="#text"?null:B==null?void 0:B.$el});Z(()=>o.value,s=>{s==null||s.addEventListener("click",y,!1),s==null||s.addEventListener("mouseover",w,!1),s==null||s.addEventListener("mouseout",S,!1)}),$e(()=>{var s,v,a;(s=o.value)==null||s.removeEventListener("click",y,!1),(v=o.value)==null||v.removeEventListener("mouseover",w,!1),(a=o.value)==null||a.removeEventListener("mouseout",S,!1)});function y(s){s.stopPropagation(),x.setCheckedNode(d.schema)}function w(s){d.schema.type!=="page"&&(s.stopPropagation(),x.setHoverNode(d.schema))}function S(s){s.stopPropagation(),x.setHoverNode(null)}return(s,v)=>{var a,r;const f=Te("ENodeItem");return E(),ee(u(Ie),{ref_key:"nodeRef",ref:c,componentSchema:d.schema},Re({_:2},[(r=(a=u(z).getComponentConfingByType(d.schema.type))==null?void 0:a.editConstraints)!=null&&r.childImmovable?{name:"edit-node",fn:te(()=>[(E(!0),P(X,null,de(d.schema.children,l=>(E(),ee(f,{key:l.id,schema:l},null,8,["schema"]))),128))]),key:"0"}:{name:"edit-node",fn:te(()=>[d.schema.children?(E(),ee(Ae,{key:0,schemas:d.schema.children,"onUpdate:schemas":v[0]||(v[0]=l=>d.schema.children=l)},null,8,["schemas"])):ve("",!0)]),key:"1"}]),1032,["componentSchema"])}}}),Ze={class:"min-w-750px rounded h-full"},He=H({__name:"previewJson",setup(M,{expose:R}){const x=z.getComponent("modal"),p=z.getComponent("monacoEditor"),c={theme:"vs-light",selectOnLineNumbers:!0,minimap:{enabled:!1},readOnly:!0},d=_(null),o=_(!1),y=D("pageSchema");function w(){o.value=!1}function S(){o.value=!0,d.value?d.value.setValue(JSON.stringify(y,null,2)):setTimeout(()=>{S()},300)}function s(v="epic-data.json"){let a="data:text/json;charset=utf-8,";a+=JSON.stringify(y,null,2);var r=encodeURI(a),f=document.createElement("a");f.setAttribute("href",r),f.setAttribute("download",v),f.click()}return R({handleOpen:S}),(v,a)=>(E(),ee(u(x),{modelValue:o.value,"onUpdate:modelValue":a[0]||(a[0]=r=>o.value=r),title:"查看数据",class:"w-900px",width:"900px",onClose:w,onOk:s,okText:"导出数据"},{default:te(()=>[N("div",Ze,[V(u(p),{ref_key:"monacoEditorRef",ref:d,class:"editor h-full",autoToggleTheme:"",config:c,language:"json"},null,512)])]),_:1},8,["modelValue"]))}}),Ke={class:"epic-edit-toolbar flex items-center justify-between px-4"},qe={class:"flex-1 h-full flex items-center"},Ye=["title","onClick"],Qe={class:"flex-1 h-full flex items-center justify-center"},Ge=["title","onClick"],Xe={class:"flex-1 h-full flex items-center justify-end"},et={key:0,class:"flex items-center ml-12px"},tt={class:"pr-8px w-82px cursor-pointer"},lt={class:"w-90px cursor-pointer"},nt=H({__name:"toolbar",setup(M){const R=z.getComponent("slider"),x=z.getComponent("select"),{canvasScale:p,disabledZoom:c}=me(),d=_("pc"),o=D("pageSchema"),y=D("designer"),w=_(null),S=[{icon:"icon-a-diannaotoubu",title:"pc",key:"pc"},{icon:"icon-a-pingbantoubu",title:"平板",key:"pad"},{icon:"icon-a-shoujitoubu",title:"手机",key:"mobile"}],s=W.recordList,v=W.undoList,a=F(()=>[{icon:"icon-daima1",title:"查看数据",on:()=>L()},{icon:"icon-shangchuan1",title:"导入数据",on:Q},{icon:"icon-shanchu1",title:"清空",on:B},{icon:"icon-chexiao2x",title:"撤销",on:j,disabled:!s.value.length},{icon:"icon-fanhui2x",title:"重做",on:I,disabled:!v.value.length}]),r=_(null),f=F({get(){return`${(p.value*100).toFixed(0)}%`},set(t){p.value=Number(t)}}),l=[{label:"60%",value:"0.6"},{label:"80%",value:"0.8"},{label:"100%",value:"1.0"},{label:"120%",value:"1.2"},{label:"140%",value:"1.4"}];function j(){const t=W.undo();t&&(se(o.schemas,t),y.setCheckedNode(o.schemas[0]))}function I(){const t=W.redo();t&&(se(o.schemas,t),y.setCheckedNode(o.schemas[0]))}function B(){y.reset()}function L(){w.value.handleOpen()}function Q(){var t;(t=r.value)==null||t.click()}function K(t){var e;const i=(e=t.target.files)==null?void 0:e[0];if(!i)return;t.target.value=null;const U=new FileReader;U.readAsText(i),U.onload=A=>{var le;J((le=A.target)==null?void 0:le.result)}}function J(t){try{let e=JSON.parse(t??"");e.schemas||(e=ze(e)),se(o,e)}catch(e){console.error(e)}}function G(t){y.handleToggleDeviceMode(t),d.value=t;const e={pc:{},pad:{width:"800px",mode:t},mobile:{width:"420px",mode:t}};o.canvas=e[t]}return(t,e)=>(E(),P(X,null,[N("div",Ke,[N("div",qe,[(E(!0),P(X,null,de(a.value,(i,U)=>(E(),P("div",{title:i.title,class:Y(["epic-action-item h-90% px-10px flex items-center cursor-pointer",{disabled:i.disabled}]),key:U,onClick:i.on},[V(u(ae),{name:i.icon},null,8,["name"])],10,Ye))),128))]),ue(N("input",{type:"file",ref_key:"fileRef",ref:r,accept:".json,.txt",onChange:K},null,544),[[ce,!1]]),N("div",Qe,[(E(),P(X,null,de(S,i=>N("div",{title:i.title,class:Y(["epic-device-item h-90% px-10px flex items-center cursor-pointer",{checked:i.key===d.value}]),key:i.key,onClick:U=>G(i.key)},[V(u(ae),{name:i.icon},null,8,["name"])],10,Ge)),64))]),N("div",Xe,[u(c)?ve("",!0):(E(),P("div",et,[N("div",tt,[V(u(x),{value:f.value,"onUpdate:value":e[0]||(e[0]=i=>f.value=i),modelValue:f.value,"onUpdate:modelValue":e[1]||(e[1]=i=>f.value=i),options:l,size:"small"},null,8,["value","modelValue"])]),N("div",lt,[V(u(R),{min:.6,max:1.4,step:.01,tooltip:!1,value:u(p),"onUpdate:value":e[2]||(e[2]=i=>fe(p)?p.value=i:null),modelValue:u(p),"onUpdate:modelValue":e[3]||(e[3]=i=>fe(p)?p.value=i:null)},null,8,["value","modelValue"])])]))])]),V(He,{ref_key:"previewJson",ref:w},null,512)],64))}}),at={class:"h-full flex flex-col relative"},ot=["draggable"],it=H({__name:"editScreenContainer",setup(M){const R=D("pageSchema"),x=_(null),p=_(null),c=_(null),{pressSpace:d,disabledZoom:o}=me(),{handleElementDragStart:y,handleElementDrag:w,handleElementDragEnd:S}=Ve(x),{width:s,height:v}=De(x),{canvasScale:a,handleZoom:r}=Le(p);let f=0,l=0;const j=_({}),I=_({}),B=_({}),L=Se({width:0,height:0});Z(()=>{var t,e;return{width:(t=R.canvas)==null?void 0:t.width,height:(e=R.canvas)==null?void 0:e.height}},K),Z(B,()=>{pe(Q)}),xe(()=>{var t,e;K({width:(t=R.canvas)==null?void 0:t.width,height:(e=R.canvas)==null?void 0:e.height})});function Q(){const t=u(c);t&&(L.value={width:t.clientWidth,height:t.clientHeight})}function K({width:t,height:e}){B.value={width:t??"0",height:e??"0"}}je(s,J),Z(L,J);function J(){if(o.value){I.value={width:f+"px",height:l+"px",transform:"translate(0px, 20px)"};return}let t=L.value.width||f,e=L.value.height||l;j.value={width:s.value+t+"px",height:v.value+e+"px"},I.value={width:t+"px",height:e+"px"},G()}function G(){pe(()=>{var t;let e=L.value.width||f;const i=(L.value.height||l)/2,U=e/2;(t=x.value)==null||t.scrollTo(U,i)})}return re(x,([{contentRect:t}])=>{if(f=t.width-60,l=t.height-80,!o.value)if(L.value.width===0)a.value=1;else{const e=(f-20)/L.value.width;a.value=e<1.2?e:a.value}Ue(J,50)()}),(t,e)=>(E(),P("div",at,[V(nt),N("div",{ref_key:"editScreenContainerRef",ref:x,class:Y(["flex-1 overflow-auto overflow-y-hidden epic-edit-screen-container",{"cursor-grab":u(d)}]),draggable:u(d),onWheel:e[0]||(e[0]=(...i)=>u(r)&&u(r)(...i)),onDragstart:e[1]||(e[1]=(...i)=>u(y)&&u(y)(...i)),onDragend:e[2]||(e[2]=(...i)=>u(S)&&u(S)(...i)),onDrag:e[3]||(e[3]=(...i)=>u(w)&&u(w)(...i))},[N("div",{id:"canvasContainer",class:"flex items-center justify-center",style:ne(j.value)},[N("div",{ref_key:"draggableElRef",ref:p,class:"transition-all"},[N("div",{class:Y({"pointer-events-none":u(d)}),style:ne(I.value)},[Ee(t.$slots,"default")],6)],512)],4)],42,ot),N("div",{ref_key:"sizeBoxRef",ref:c,class:"absolute op-0 pointer-events-none",style:ne(B.value)},null,4)]))}}),st={class:"epic-edit-canvas"},mt=H({__name:"index",setup(M){const R=_(null),x=_(null),p=D("pageSchema"),c=F(()=>p.schemas[0]),d=F(()=>({width:"100%",height:"100%"}));return xe(()=>{var o;(o=x.value)==null||o.handleInit(R.value)}),(o,y)=>(E(),P("section",st,[V(it,null,{default:te(()=>[N("div",{ref_key:"epicEditRangeRef",ref:R,class:"epic-edit-range rounded-md overflow-auto relative",style:ne(d.value)},[V(ye,{schema:c.value},null,8,["schema"]),V(Je,{ref_key:"ePreviewWidgetsRef",ref:x},null,512)],4)]),_:1})]))}});export{mt as default};
