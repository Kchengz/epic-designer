import{d as G,j as N,N as L,h as P,k as xe,o as I,c as U,I as j,w as le,l as w,P as ae,x as W,al as ue,am as ce,m as u,t as we,e as ve,n as Q,F as ee,aj as Ne,Z as _e,z as Re,E as Se,b as te,an as Ee,D as de,G as Ie,R as pe,r as $e,M as Be,ao as fe}from"./framework.Bp6pYewT.js";import{e as he,T as M,s as Te,A as Ve,I as je,D as Le,g as Oe,j as re,_ as De,C as ge,y as Ue,h as J,Z as se,x as Me}from"./index-D0Hjkk1x.DbREz0MF.js";import{m as oe}from"./icon.vue_vue_type_script_setup_true_lang-BKjDMfHm.DAq6Hevl.js";import{R as Pe}from"./vuedraggable.umd-Bo-O9gJ9.nAYIeQOV.js";const Ze={class:"epic-action-item whitespace-nowrap"},Fe={key:0,class:"flex"},Je=G({__name:"previewWidgets",setup(Z,{expose:S}){const g=L("pageManager",{}),p=L("pageSchema"),c=L("designer"),d=L("designerProps"),a=N(null),x=N(null),k=N(null),E=N(!1),s=N(!1),h=N(!0),o=N("top"),{canvasScale:r,disabledZoom:v}=he();let n=null;const D=P(()=>{const l=c.state.checkedNode;return!(!(l!=null&&l.id)||d.value.lockDefaultSchemaEdit&&g.defaultComponentIds.value.includes(l==null?void 0:l.id))}),T=P(()=>{var l,f,m,C,y;const b=g.componentInstances.value,_=(l=c.state.checkedNode)==null?void 0:l.id,R=M.getComponentConfingByType((f=c.state.checkedNode)==null?void 0:f.type)??null;if(!_||!(b!=null&&b[_]))return null;if(R!=null&&R.defaultSchema.input&&((m=c.state.checkedNode)==null?void 0:m.noFormItem)!==!0)return(C=b[_+"formItem"])==null?void 0:C.$el;const $=b[_];return((y=$==null?void 0:$.$el)==null?void 0:y.nodeName)==="#text"?null:$==null?void 0:$.$el}),B=P(()=>{var l,f,m,C;const y=g.componentInstances.value,b=(l=c.state.hoverNode)==null?void 0:l.id,_=M.getComponentConfingByType((f=c.state.hoverNode)==null?void 0:f.type)??null;if(!b||!(y!=null&&y[b]))return null;if(_!=null&&_.defaultSchema.input&&((m=c.state.hoverNode)==null?void 0:m.noFormItem)!==!0)return(C=y[b+"formItem"])==null?void 0:C.$el;const R=y[b];return(R==null?void 0:R.$el.nodeName)==="#text"?null:R==null?void 0:R.$el}),{mutationObserver:O,observerConfig:K}=me(A),{startTimedQuery:H,stopTimedQuery:z}=De(A);W(()=>T.value,l=>{if(l){E.value=!0,O.observe(l,K);const f=l.parentNode;f&&(f.ondragstart=()=>{h.value=!1,H()},f.ondragend=()=>{h.value=!0,z()}),A()}else E.value=!1});const{mutationObserver:Y,observerConfig:t}=me(ie);W(()=>B.value,l=>{l&&(Y.observe(l,t),ie())});let e=0;W(()=>{var l;return(l=c.state.hoverNode)==null?void 0:l.id},l=>{if(l){s.value=!0,clearTimeout(e);return}e=setTimeout(()=>{s.value=!1},300)});let i=0,F=0;function A(){const l=T.value;if(!l||!n)return;const{top:f,left:m,height:C}=n==null?void 0:n.getBoundingClientRect(),{top:y,left:b,width:_,height:R}=l.getBoundingClientRect(),$=v.value?1:r.value,V=y-f+((n==null?void 0:n.scrollTop)??0)*$,q=b-m+((n==null?void 0:n.scrollLeft)??0)*$,X=R/$;a.value&&(a.value.style.width=`${_/$}px`,a.value.style.height=`${X}px`,a.value.style.top=`${V/$}px`,a.value.style.left=`${q/$}px`,ne(V,q)),k.value&&(V<45&&X<100?(k.value.style.top="",k.value.style.bottom="-30px",k.value.style["border-radius"]="0px 0px 4px 4px",o.value="bottom"):V<45?(k.value.style.top="0px",k.value.style["border-radius"]="0px 0px 4px 0",o.value="center"):(k.value.style.top="-30px",k.value.style["border-radius"]="4px 4px 0px 0px",o.value="top"))}function ne(l,f){const m=T.value;if(!n||!m)return;const C=n.getBoundingClientRect(),{width:y}=m.getBoundingClientRect(),b=v.value?1:r.value,_=l/b-C.top;let R=f/b-C.left+y/b;R<C.width&&(R=0);const $=n.scrollTop-C.height/3+60,V=n.scrollTop+C.height/3*2,q=n.scrollLeft-C.width+200,X=n.scrollLeft+C.width-200;Math.abs(_-i)<10&&Math.abs(R-F)<10||(i=_,F=R,!(_>$&&_<V&&R>q&&R<X)&&(n.scrollTop=_,n.scrollLeft=R))}function ie(){var l,f;const m=B.value;if(!m)return;const{top:C,left:y}=(n==null?void 0:n.getBoundingClientRect())??{top:0,left:0},{top:b,left:_,width:R,height:$}=((l=m.getBoundingClientRect)==null?void 0:l.call(m))??((f=m.nextElementSibling)==null?void 0:f.getBoundingClientRect()),V=v.value?1:r.value,q=b-C+((n==null?void 0:n.scrollTop)??0)*V,X=_-y+((n==null?void 0:n.scrollLeft)??0)*V;x.value&&(x.value.style.width=`${R/V}px`,x.value.style.height=`${$/V}px`,x.value.style.top=`${q/V}px`,x.value.style.left=`${X/V}px`)}function me(l){const f=window.MutationObserver,m={childList:!0,attributes:!0,subtree:!0};return{mutationObserver:new f(l),observerConfig:m}}function be(){var l;const f=ge(p.schemas,((l=c.state.checkedNode)==null?void 0:l.id)??"root");if(!f)return!1;const{list:m,schema:C,index:y}=f,b=Ue(C);m.splice(y+1,0,b),c.setCheckedNode(b),J.push(p.schemas,"复制组件")}function ke(){var l;const f=ge(p.schemas,((l=c.state.checkedNode)==null?void 0:l.id)??"root");if(!f)return!1;let{list:m,schema:C,index:y}=f;m.splice(y,1),y===m.length&&y--,c.setCheckedNode(m[y]),J.push(p.schemas,"删除组件")}function Ce(l){n=l,n==null||n.addEventListener("scroll",()=>{A()}),re(T,A),re(B,ie)}return S({handleInit:Ce}),(l,f)=>{var m,C,y,b,_;return I(),U(ee,null,[ue(w("div",{ref_key:"selectorRef",ref:a,class:Q(["checked-widget absolute pointer-events-none z-20",o.value+" "+(h.value?"transition-all":"")])},[w("div",{class:"action-box",ref_key:"actionBoxRef",ref:k},[w("div",Ze,we((C=u(M).getComponentConfingByType(((m=u(c).state.checkedNode)==null?void 0:m.type)??""))==null?void 0:C.defaultSchema.label),1),D.value?(I(),U("div",Fe,[w("div",{title:"复制",class:"epic-action-item pointer-events-auto",onClick:be},[j(u(oe),{name:"icon-fuzhi3"})]),w("div",{title:"删除",class:"epic-action-item pointer-events-auto",onClick:ke},[j(u(oe),{name:"icon-shanchu1"})])])):ve("",!0)],512)],2),[[ce,E.value&&((y=u(c).state.checkedNode)==null?void 0:y.id)!=="root"]]),ue(w("div",{ref_key:"hoverWidgetRef",ref:x,class:"hover-widget absolute transition-all pointer-events-none z-998"},null,512),[[ce,s.value&&((b=u(c).state.checkedNode)==null?void 0:b.id)!==((_=u(c).state.hoverNode)==null?void 0:_.id)]])],64)}}}),ze=G({name:"EditNodeItem",__name:"editNodeItem",props:{schemas:{}},emits:["update:schemas"],setup(Z,{emit:S}){const g=L("designer"),p=L("pageSchema"),c=Z,d=S,a=P({get(){return c.schemas},set(h){d("update:schemas",h)}});function x(h){g.setCheckedNode(a.value[h]),g.setDisableHover(!0)}function k(){g.setDisableHover(),J.push(p.schemas,"拖拽组件")}function E(){J.push(p.schemas,"插入组件")}function s(h){return h.type==="page"||M.getComponentConfingByType(h.type).immovable?"unmover-item":"draggable-item"}return(h,o)=>(I(),te(u(Pe),Be({modelValue:a.value,"onUpdate:modelValue":o[0]||(o[0]=r=>a.value=r),"item-key":"id","component-data":{type:"transition-group"},class:"draggable-range"},{animation:200,group:"edit-draggable",handle:".draggable-item",ghostClass:"moveing"},{onStart:o[1]||(o[1]=r=>x(r.oldIndex)),onEnd:o[2]||(o[2]=r=>k()),onAdd:o[3]||(o[3]=r=>{x(r.newIndex),E()})}),{item:le(({element:r,index:v})=>[(I(),U("div",{class:Q(["widget-box",s(r)]),key:v},[j(ye,{schema:r},null,8,["schema"])],2))]),_:1},16,["modelValue"]))}}),ye=G({name:"ENodeItem",__name:"nodeItem",props:{schema:{},name:{}},setup(Z){const S=Ne(),g=L("designer"),p=L("pageManager",{}),c=N(null);_e("nodeAttrs",S);const d=Z,a=P(()=>{var s,h,o,r,v;const n=p.componentInstances.value,D=(s=d.schema)==null?void 0:s.id,T=M.getComponentConfingByType((h=d.schema)==null?void 0:h.type)??null;if(!D||!(n!=null&&n[D]))return null;if(T!=null&&T.defaultSchema.input&&((o=d.schema)==null?void 0:o.noFormItem)!==!0)return(r=n[D+"formItem"])==null?void 0:r.$el;const B=n[D];return((v=B==null?void 0:B.$el)==null?void 0:v.nodeName)==="#text"?null:B==null?void 0:B.$el});W(()=>a.value,s=>{s==null||s.addEventListener("click",x,!1),s==null||s.addEventListener("mouseover",k,!1),s==null||s.addEventListener("mouseout",E,!1)}),Re(()=>{var s,h,o;(s=a.value)==null||s.removeEventListener("click",x,!1),(h=a.value)==null||h.removeEventListener("mouseover",k,!1),(o=a.value)==null||o.removeEventListener("mouseout",E,!1)});function x(s){s.stopPropagation(),g.setCheckedNode(d.schema)}function k(s){d.schema.type!=="page"&&(s.stopPropagation(),g.setHoverNode(d.schema))}function E(s){s.stopPropagation(),g.setHoverNode(null)}return(s,h)=>{var o;const r=Se("ENodeItem");return I(),te(u(Te),{ref_key:"nodeRef",ref:c,componentSchema:d.schema},Ee({_:2},[(o=u(M).getComponentConfingByType(d.schema.type))!=null&&o.childImmovable?{name:"edit-node",fn:le(()=>[(I(!0),U(ee,null,de(d.schema.children,v=>(I(),te(r,{key:v.id,schema:v},null,8,["schema"]))),128))]),key:"0"}:{name:"edit-node",fn:le(()=>[d.schema.children?(I(),te(ze,{key:0,schemas:d.schema.children,"onUpdate:schemas":h[0]||(h[0]=v=>d.schema.children=v)},null,8,["schemas"])):ve("",!0)]),key:"1"}]),1032,["componentSchema"])}}}),Ae={class:"min-w-750px rounded bg-white h-full"},We=G({__name:"previewJson",setup(Z,{expose:S}){const g=M.getComponent("modal"),p=M.getComponent("monacoEditor"),c={theme:"vs-light",selectOnLineNumbers:!0,minimap:{enabled:!1},readOnly:!0},d=N(null),a=N(!1),x=L("pageSchema");function k(){a.value=!1}function E(){a.value=!0,d.value?d.value.setValue(JSON.stringify(x,null,2)):setTimeout(()=>{E()},300)}function s(h="epic-data.json"){let o="data:text/json;charset=utf-8,";o+=JSON.stringify(x,null,2);var r=encodeURI(o),v=document.createElement("a");v.setAttribute("href",r),v.setAttribute("download",h),v.click()}return S({handleOpen:E}),(h,o)=>(I(),te(u(g),{modelValue:a.value,"onUpdate:modelValue":o[0]||(o[0]=r=>a.value=r),title:"查看数据",class:"w-900px",width:"900px",onClose:k,onOk:s,okText:"导出数据"},{default:le(()=>[w("div",Ae,[j(u(p),{ref_key:"monacoEditorRef",ref:d,class:"editor h-full",config:c,language:"json"},null,512)])]),_:1},8,["modelValue"]))}}),Ge={class:"epic-edit-toolbar flex items-center justify-between px-4"},He={class:"flex-1 h-full flex items-center"},qe=["title","onClick"],Xe={class:"flex-1 h-full flex items-center justify-center"},Qe=["title","onClick"],Ke={class:"flex-1 h-full flex items-center justify-end"},Ye={key:0,class:"flex items-center ml-12px"},et={class:"pr-8px w-82px cursor-pointer"},tt={class:"w-90px cursor-pointer"},lt=G({__name:"toolbar",setup(Z){const S=M.getComponent("slider"),g=M.getComponent("select"),{canvasScale:p,disabledZoom:c}=he(),d=N("pc"),a=L("pageSchema"),x=L("designer"),k=N(null),E=[{icon:"icon-a-diannaotoubu",title:"pc",key:"pc"},{icon:"icon-a-pingbantoubu",title:"平板",key:"pad"},{icon:"icon-a-shoujitoubu",title:"手机",key:"mobile"}],s=J.recordList,h=J.undoList,o=P(()=>[{icon:"icon-daima1",title:"查看数据",on:()=>O()},{icon:"icon-shangchuan1",title:"导入数据",on:K},{icon:"icon-shanchu1",title:"清空",on:B},{icon:"icon-chexiao2x",title:"撤销",on:D,disabled:!s.value.length},{icon:"icon-fanhui2x",title:"重做",on:T,disabled:!h.value.length}]),r=N(null),v=P({get(){return`${(p.value*100).toFixed(0)}%`},set(t){p.value=Number(t)}}),n=[{label:"60%",value:"0.6"},{label:"80%",value:"0.8"},{label:"100%",value:"1.0"},{label:"120%",value:"1.2"},{label:"140%",value:"1.4"}];function D(){const t=J.undo();t&&(se(a.schemas,t),x.setCheckedNode(a.schemas[0]))}function T(){const t=J.redo();t&&(se(a.schemas,t),x.setCheckedNode(a.schemas[0]))}function B(){x.reset()}function O(){k.value.handleOpen()}function K(){var t;(t=r.value)==null||t.click()}function H(t){var e;const i=(e=t.target.files)==null?void 0:e[0];if(!i)return;t.target.value=null;const F=new FileReader;F.readAsText(i),F.onload=A=>{var ne;z((ne=A.target)==null?void 0:ne.result)}}function z(t){try{let e=JSON.parse(t??"");e.schemas||(e=Me(e)),se(a,e)}catch(e){console.error(e)}}function Y(t){x.handleToggleDeviceMode(t),d.value=t;const e={pc:{},pad:{width:"800px",mode:t},mobile:{width:"420px",mode:t}};a.canvas=e[t]}return(t,e)=>(I(),U(ee,null,[w("div",Ge,[w("div",He,[(I(!0),U(ee,null,de(o.value,(i,F)=>(I(),U("div",{title:i.title,class:Q(["epic-action-item h-90% px-10px flex items-center hover:bg-gray-50 cursor-pointer",{disabled:i.disabled}]),key:F,onClick:i.on},[j(u(oe),{name:i.icon},null,8,["name"])],10,qe))),128))]),ue(w("input",{type:"file",ref_key:"fileRef",ref:r,accept:".json,.txt",onChange:H},null,544),[[ce,!1]]),w("div",Xe,[(I(),U(ee,null,de(E,i=>w("div",{title:i.title,class:Q(["epic-device-item h-90% px-10px flex items-center hover:bg-gray-50 cursor-pointer",{checked:i.key===d.value}]),key:i.key,onClick:F=>Y(i.key)},[j(u(oe),{name:i.icon},null,8,["name"])],10,Qe)),64))]),w("div",Ke,[u(c)?ve("",!0):(I(),U("div",Ye,[w("div",et,[j(u(g),{value:v.value,"onUpdate:value":e[0]||(e[0]=i=>v.value=i),modelValue:v.value,"onUpdate:modelValue":e[1]||(e[1]=i=>v.value=i),options:n,size:"small"},null,8,["value","modelValue"])]),w("div",tt,[j(u(S),{min:.6,max:1.4,step:.01,tooltip:!1,value:u(p),"onUpdate:value":e[2]||(e[2]=i=>fe(p)?p.value=i:null),modelValue:u(p),"onUpdate:modelValue":e[3]||(e[3]=i=>fe(p)?p.value=i:null)},null,8,["value","modelValue"])])]))])]),j(We,{ref_key:"previewJson",ref:k},null,512)],64))}}),nt={class:"h-full flex flex-col relative"},at=["draggable"],ot=G({__name:"editScreenContainer",setup(Z){const S=L("pageSchema"),g=N(null),p=N(null),c=N(null),{pressSpace:d,disabledZoom:a}=he(),{handleElementDragStart:x,handleElementDrag:k,handleElementDragEnd:E}=Ve(g),{width:s,height:h}=je(g),{canvasScale:o,handleZoom:r}=Le(p);let v=0,n=0;const D=N({}),T=N({}),B=N({}),O=Ie({width:0,height:0});W(()=>{var t,e;return{width:(t=S.canvas)==null?void 0:t.width,height:(e=S.canvas)==null?void 0:e.height}},H),W(B,()=>{pe(K)}),xe(()=>{var t,e;H({width:(t=S.canvas)==null?void 0:t.width,height:(e=S.canvas)==null?void 0:e.height})});function K(){const t=u(c);t&&(O.value={width:t.clientWidth,height:t.clientHeight})}function H({width:t,height:e}){B.value={width:t??"0",height:e??"0"}}Oe(s,z),W(O,z);function z(){if(a.value){T.value={width:v+"px",height:n+"px",transform:"translate(0px, 20px)"};return}let t=O.value.width||v,e=O.value.height||n;D.value={width:s.value+t+"px",height:h.value+e+"px"},T.value={width:t+"px",height:e+"px"},Y()}function Y(){pe(()=>{let t=O.value.width||v;const e=(O.value.height||n)/2,i=t/2;g.value.scrollTo(i,e)})}return re(g,([{contentRect:t}])=>{if(v=t.width-60,n=t.height-80,!a.value)if(O.value.width===0)o.value=1;else{const e=(v-20)/O.value.width;o.value=e<1.2?e:o.value}z()}),(t,e)=>(I(),U("div",nt,[j(lt),w("div",{ref_key:"editScreenContainerRef",ref:g,class:Q(["flex-1 overflow-auto overflow-y-hidden epic-edit-screen-container",{"cursor-grab":u(d)}]),draggable:u(d),onWheel:e[0]||(e[0]=(...i)=>u(r)&&u(r)(...i)),onDragstart:e[1]||(e[1]=(...i)=>u(x)&&u(x)(...i)),onDragend:e[2]||(e[2]=(...i)=>u(E)&&u(E)(...i)),onDrag:e[3]||(e[3]=(...i)=>u(k)&&u(k)(...i))},[w("div",{id:"canvasContainer",class:"flex items-center justify-center",style:ae(D.value)},[w("div",{ref_key:"draggableElRef",ref:p,class:"transition-all"},[w("div",{class:Q({"pointer-events-none":u(d)}),style:ae(T.value)},[$e(t.$slots,"default")],6)],512)],4)],42,at),w("div",{ref_key:"sizeBoxRef",ref:c,class:"absolute op-0 pointer-events-none",style:ae(B.value)},null,4)]))}}),it={class:"epic-edit-canvas"},rt=G({__name:"index",setup(Z){const S=N(null),g=N(null),p=L("pageSchema"),c=P(()=>p.schemas[0]),d=P(()=>({width:"100%",height:"100%"}));return xe(()=>{var a;(a=g.value)==null||a.handleInit(S.value)}),(a,x)=>(I(),U("section",it,[j(ot,null,{default:le(()=>[w("div",{ref_key:"epicEditRangeRef",ref:S,class:"epic-edit-range rounded-md overflow-auto relative",style:ae(d.value)},[j(ye,{schema:c.value},null,8,["schema"]),j(Je,{ref_key:"ePreviewWidgetsRef",ref:g},null,512)],4)]),_:1})]))}});export{rt as default};
