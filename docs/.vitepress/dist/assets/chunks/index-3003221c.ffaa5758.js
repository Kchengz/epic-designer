import{i as H,r as R,k as j,m as P,b as we,o as B,c as D,e as O,v as ae,d as _,a3 as ie,w as G,aa as de,ab as re,u,a4 as Se,C as me,G as Q,F as le,l as $e,p as Ee,n as Ie,q as Be,t as ne,af as Te,E as ve,s as Ve,H as ye,B as Le,y as Oe,ae as be}from"../app.c1700df1.js";import{c8 as pe,N as M,c9 as je,ca as Ue,cb as De,cc as Me,cd as Pe,ce as he,cf as Fe,cg as ke,ch as Je,ci as Z,cj as ce,ck as Ze}from"./index.fb95377d.js";import{m as se}from"./icon.vue_vue_type_script_setup_true_lang-3f9e4127.b898144b.js";import{R as ze}from"./vuedraggable.umd-6a5b6da9.96e89de6.js";const Ae={class:"epic-action-item whitespace-nowrap"},Ge={key:0,class:"flex"},He=H({__name:"previewWidgets",setup(F,{expose:$}){const x=j("pageManager",{}),f=j("pageSchema"),c=j("designer"),d=j("designerProps"),a=R(null),y=R(null),w=R(null),E=R(!1),s=R(!1),h=R(!0),o=R("top"),{canvasScale:r,disabledZoom:v}=pe();let n=null;const U=P(()=>{const l=c.state.checkedNode;return!(!(l!=null&&l.id)||d.value.lockDefaultSchemaEdit&&x.defaultComponentIds.value.includes(l==null?void 0:l.id))}),L=P(()=>{var I;var l,g,m,C,b;const p=x.componentInstances.value,k=(l=c.state.checkedNode)==null?void 0:l.id,N=(I=M.getComponentConfingByType((g=c.state.checkedNode)==null?void 0:g.type))!=null?I:null;if(!k||!(p!=null&&p[k]))return null;if(N!=null&&N.defaultSchema.input&&((m=c.state.checkedNode)==null?void 0:m.noFormItem)!==!0)return(C=p[k+"formItem"])==null?void 0:C.$el;const S=p[k];return((b=S==null?void 0:S.$el)==null?void 0:b.nodeName)==="#text"?null:S==null?void 0:S.$el}),V=P(()=>{var S;var l,g,m,C;const b=x.componentInstances.value,p=(l=c.state.hoverNode)==null?void 0:l.id,k=(S=M.getComponentConfingByType((g=c.state.hoverNode)==null?void 0:g.type))!=null?S:null;if(!p||!(b!=null&&b[p]))return null;if(k!=null&&k.defaultSchema.input&&((m=c.state.hoverNode)==null?void 0:m.noFormItem)!==!0)return(C=b[p+"formItem"])==null?void 0:C.$el;const N=b[p];return(N==null?void 0:N.$el.nodeName)==="#text"?null:N==null?void 0:N.$el}),{mutationObserver:T,observerConfig:K}=fe(A),{startTimedQuery:W,stopTimedQuery:z}=Fe(A);G(()=>L.value,l=>{if(l){E.value=!0,T.observe(l,K);const g=l.parentNode;g&&(g.ondragstart=()=>{h.value=!1,W()},g.ondragend=()=>{h.value=!0,z()}),A()}else E.value=!1});const{mutationObserver:Y,observerConfig:e}=fe(ue);G(()=>V.value,l=>{l&&(Y.observe(l,e),ue())});let t=0;G(()=>{var l;return(l=c.state.hoverNode)==null?void 0:l.id},l=>{if(l){s.value=!0,clearTimeout(t);return}t=setTimeout(()=>{s.value=!1},300)});let i=0,J=0;function A(){var ee,te;const l=L.value;if(!l||!n)return;const{top:g,left:m,height:C}=n==null?void 0:n.getBoundingClientRect(),{top:b,left:p,width:k,height:N}=l.getBoundingClientRect(),S=v.value?1:r.value,I=b-g+((ee=n==null?void 0:n.scrollTop)!=null?ee:0)*S,q=p-m+((te=n==null?void 0:n.scrollLeft)!=null?te:0)*S,X=N/S;a.value&&(a.value.style.width=`${k/S}px`,a.value.style.height=`${X}px`,a.value.style.top=`${I/S}px`,a.value.style.left=`${q/S}px`,oe(I,q)),w.value&&(I<45&&X<100?(w.value.style.top="",w.value.style.bottom="-30px",w.value.style["border-radius"]="0px 0px 4px 4px",o.value="bottom"):I<45?(w.value.style.top="0px",w.value.style["border-radius"]="0px 0px 4px 0",o.value="center"):(w.value.style.top="-30px",w.value.style["border-radius"]="4px 4px 0px 0px",o.value="top"))}function oe(l,g){const m=L.value;if(!n||!m)return;const C=n.getBoundingClientRect(),{width:b}=m.getBoundingClientRect(),p=v.value?1:r.value,k=l/p-C.top;let N=g/p-C.left+b/p;N<C.width&&(N=0);const S=n.scrollTop-C.height/3+60,I=n.scrollTop+C.height/3*2,q=n.scrollLeft-C.width+200,X=n.scrollLeft+C.width-200;Math.abs(k-i)<10&&Math.abs(N-J)<10||(i=k,J=N,!(k>S&&k<I&&N>q&&N<X)&&(n.scrollTop=k,n.scrollLeft=N))}function ue(){var ee,te,ge,xe;var l,g;const m=V.value;if(!m)return;const{top:C,left:b}=(ee=n==null?void 0:n.getBoundingClientRect())!=null?ee:{top:0,left:0},{top:p,left:k,width:N,height:S}=(te=(l=m.getBoundingClientRect)==null?void 0:l.call(m))!=null?te:(g=m.nextElementSibling)==null?void 0:g.getBoundingClientRect(),I=v.value?1:r.value,q=p-C+((ge=n==null?void 0:n.scrollTop)!=null?ge:0)*I,X=k-b+((xe=n==null?void 0:n.scrollLeft)!=null?xe:0)*I;y.value&&(y.value.style.width=`${N/I}px`,y.value.style.height=`${S/I}px`,y.value.style.top=`${q/I}px`,y.value.style.left=`${X/I}px`)}function fe(l){const g=window.MutationObserver,m={childList:!0,attributes:!0,subtree:!0};return{mutationObserver:new g(l),observerConfig:m}}function Ne(){var k;var l;const g=ke(f.schemas,(k=(l=c.state.checkedNode)==null?void 0:l.id)!=null?k:"root");if(!g)return!1;const{list:m,schema:C,index:b}=g,p=Je(C);m.splice(b+1,0,p),c.setCheckedNode(p),Z.push(f.schemas,"\u590D\u5236\u7EC4\u4EF6")}function _e(){var p;var l;const g=ke(f.schemas,(p=(l=c.state.checkedNode)==null?void 0:l.id)!=null?p:"root");if(!g)return!1;let{list:m,schema:C,index:b}=g;m.splice(b,1),b===m.length&&b--,c.setCheckedNode(m[b]),Z.push(f.schemas,"\u5220\u9664\u7EC4\u4EF6")}function Re(l){n=l,n==null||n.addEventListener("scroll",()=>{A()}),he(L,A),he(V,ue)}return $({handleInit:Re}),(l,g)=>{var N;var m,C,b,p,k;return B(),D(le,null,[de(_("div",{ref_key:"selectorRef",ref:a,class:Q(["checked-widget absolute pointer-events-none z-20",o.value+" "+(h.value?"transition-all":"")])},[_("div",{class:"action-box",ref_key:"actionBoxRef",ref:w},[_("div",Ae,Se((C=u(M).getComponentConfingByType((N=(m=u(c).state.checkedNode)==null?void 0:m.type)!=null?N:""))==null?void 0:C.defaultSchema.label),1),U.value?(B(),D("div",Ge,[_("div",{title:"\u590D\u5236",class:"epic-action-item pointer-events-auto",onClick:Ne},[O(u(se),{name:"icon-fuzhi3"})]),_("div",{title:"\u5220\u9664",class:"epic-action-item pointer-events-auto",onClick:_e},[O(u(se),{name:"icon-shanchu1"})])])):me("",!0)],512)],2),[[re,E.value&&((b=u(c).state.checkedNode)==null?void 0:b.id)!=="root"]]),de(_("div",{ref_key:"hoverWidgetRef",ref:y,class:"hover-widget absolute transition-all pointer-events-none z-998"},null,512),[[re,s.value&&((p=u(c).state.checkedNode)==null?void 0:p.id)!==((k=u(c).state.hoverNode)==null?void 0:k.id)]])],64)}}}),We=H({name:"EditNodeItem",__name:"editNodeItem",props:{schemas:{}},emits:["update:schemas"],setup(F,{emit:$}){const x=j("designer"),f=j("pageSchema"),c=F,d=$,a=P({get(){return c.schemas},set(h){d("update:schemas",h)}});function y(h){x.setCheckedNode(a.value[h]),x.setDisableHover(!0)}function w(){x.setDisableHover(),Z.push(f.schemas,"\u62D6\u62FD\u7EC4\u4EF6")}function E(){Z.push(f.schemas,"\u63D2\u5165\u7EC4\u4EF6")}function s(h){return h.type==="page"||M.getComponentConfingByType(h.type).immovable?"unmover-item":"draggable-item"}return(h,o)=>(B(),ne(u(ze),Oe({modelValue:a.value,"onUpdate:modelValue":o[0]||(o[0]=r=>a.value=r),"item-key":"id","component-data":{type:"transition-group"},class:"draggable-range"},{animation:200,group:"edit-draggable",handle:".draggable-item",ghostClass:"moveing"},{onStart:o[1]||(o[1]=r=>y(r.oldIndex)),onEnd:o[2]||(o[2]=r=>w()),onAdd:o[3]||(o[3]=r=>{y(r.newIndex),E()})}),{item:ae(({element:r,index:v})=>[(B(),D("div",{class:Q(["widget-box",s(r)]),key:v},[O(Ce,{schema:r},null,8,["schema"])],2))]),_:1},16,["modelValue"]))}}),Ce=H({name:"ENodeItem",__name:"nodeItem",props:{schema:{},name:{}},setup(F){const $=$e(),x=j("designer"),f=j("pageManager",{}),c=R(null);Ee("nodeAttrs",$);const d=F,a=P(()=>{var T;var s,h,o,r,v;const n=f.componentInstances.value,U=(s=d.schema)==null?void 0:s.id,L=(T=M.getComponentConfingByType((h=d.schema)==null?void 0:h.type))!=null?T:null;if(!U||!(n!=null&&n[U]))return null;if(L!=null&&L.defaultSchema.input&&((o=d.schema)==null?void 0:o.noFormItem)!==!0)return(r=n[U+"formItem"])==null?void 0:r.$el;const V=n[U];return((v=V==null?void 0:V.$el)==null?void 0:v.nodeName)==="#text"?null:V==null?void 0:V.$el});G(()=>a.value,s=>{s==null||s.addEventListener("click",y,!1),s==null||s.addEventListener("mouseover",w,!1),s==null||s.addEventListener("mouseout",E,!1)}),Ie(()=>{var s,h,o;(s=a.value)==null||s.removeEventListener("click",y,!1),(h=a.value)==null||h.removeEventListener("mouseover",w,!1),(o=a.value)==null||o.removeEventListener("mouseout",E,!1)});function y(s){s.stopPropagation(),x.setCheckedNode(d.schema)}function w(s){d.schema.type!=="page"&&(s.stopPropagation(),x.setHoverNode(d.schema))}function E(s){s.stopPropagation(),x.setHoverNode(null)}return(s,h)=>{var o;const r=Be("ENodeItem");return B(),ne(u(je),{ref_key:"nodeRef",ref:c,componentSchema:d.schema},Te({_:2},[(o=u(M).getComponentConfingByType(d.schema.type))!=null&&o.childImmovable?{name:"edit-node",fn:ae(()=>[(B(!0),D(le,null,ve(d.schema.children,v=>(B(),ne(r,{key:v.id,schema:v},null,8,["schema"]))),128))]),key:"0"}:{name:"edit-node",fn:ae(()=>[d.schema.children?(B(),ne(We,{key:0,schemas:d.schema.children,"onUpdate:schemas":h[0]||(h[0]=v=>d.schema.children=v)},null,8,["schemas"])):me("",!0)]),key:"1"}]),1032,["componentSchema"])}}}),qe={class:"min-w-750px rounded bg-white h-full"},Xe=H({__name:"previewJson",setup(F,{expose:$}){const x=M.getComponent("modal"),f=M.getComponent("monacoEditor"),c={theme:"vs-light",selectOnLineNumbers:!0,minimap:{enabled:!1},readOnly:!0},d=R(null),a=R(!1),y=j("pageSchema");function w(){a.value=!1}function E(){a.value=!0,d.value?d.value.setValue(JSON.stringify(y,null,2)):setTimeout(()=>{E()},300)}function s(h="epic-data.json"){let o="data:text/json;charset=utf-8,";o+=JSON.stringify(y,null,2);var r=encodeURI(o),v=document.createElement("a");v.setAttribute("href",r),v.setAttribute("download",h),v.click()}return $({handleOpen:E}),(h,o)=>(B(),ne(u(x),{modelValue:a.value,"onUpdate:modelValue":o[0]||(o[0]=r=>a.value=r),title:"\u67E5\u770B\u6570\u636E",class:"w-900px",width:"900px",onClose:w,onOk:s,okText:"\u5BFC\u51FA\u6570\u636E"},{default:ae(()=>[_("div",qe,[O(u(f),{ref_key:"monacoEditorRef",ref:d,class:"editor h-full",config:c,language:"json"},null,512)])]),_:1},8,["modelValue"]))}}),Qe={class:"epic-edit-toolbar flex items-center justify-between px-4"},Ke={class:"flex-1 h-full flex items-center"},Ye=["title","onClick"],et={class:"flex-1 h-full flex items-center justify-center"},tt=["title","onClick"],lt={class:"flex-1 h-full flex items-center justify-end"},nt={key:0,class:"flex items-center ml-12px"},at={class:"pr-8px w-82px cursor-pointer"},ot={class:"w-90px cursor-pointer"},it=H({__name:"toolbar",setup(F){const $=M.getComponent("slider"),x=M.getComponent("select"),{canvasScale:f,disabledZoom:c}=pe(),d=R("pc"),a=j("pageSchema"),y=j("designer"),w=R(null),E=[{icon:"icon-a-diannaotoubu",title:"pc",key:"pc"},{icon:"icon-a-pingbantoubu",title:"\u5E73\u677F",key:"pad"},{icon:"icon-a-shoujitoubu",title:"\u624B\u673A",key:"mobile"}],s=Z.recordList,h=Z.undoList,o=P(()=>[{icon:"icon-daima1",title:"\u67E5\u770B\u6570\u636E",on:()=>T()},{icon:"icon-shangchuan1",title:"\u5BFC\u5165\u6570\u636E",on:K},{icon:"icon-shanchu1",title:"\u6E05\u7A7A",on:V},{icon:"icon-chexiao2x",title:"\u64A4\u9500",on:U,disabled:!s.value.length},{icon:"icon-fanhui2x",title:"\u91CD\u505A",on:L,disabled:!h.value.length}]),r=R(null),v=P({get(){return`${(f.value*100).toFixed(0)}%`},set(e){f.value=Number(e)}}),n=[{label:"60%",value:"0.6"},{label:"80%",value:"0.8"},{label:"100%",value:"1.0"},{label:"120%",value:"1.2"},{label:"140%",value:"1.4"}];function U(){const e=Z.undo();e&&(ce(a.schemas,e),y.setCheckedNode(a.schemas[0]))}function L(){const e=Z.redo();e&&(ce(a.schemas,e),y.setCheckedNode(a.schemas[0]))}function V(){y.reset()}function T(){w.value.handleOpen()}function K(){var e;(e=r.value)==null||e.click()}function W(e){var t;const i=(t=e.target.files)==null?void 0:t[0];if(!i)return;e.target.value=null;const J=new FileReader;J.readAsText(i),J.onload=A=>{var oe;z((oe=A.target)==null?void 0:oe.result)}}function z(e){try{let t=JSON.parse(e!=null?e:"");t.schemas||(t=Ze(t)),ce(a,t)}catch(t){console.error(t)}}function Y(e){y.handleToggleDeviceMode(e),d.value=e;const t={pc:{},pad:{width:"800px",mode:e},mobile:{width:"420px",mode:e}};a.canvas=t[e]}return(e,t)=>(B(),D(le,null,[_("div",Qe,[_("div",Ke,[(B(!0),D(le,null,ve(o.value,(i,J)=>(B(),D("div",{title:i.title,class:Q(["epic-action-item h-90% px-10px flex items-center hover:bg-gray-50 cursor-pointer",{disabled:i.disabled}]),key:J,onClick:i.on},[O(u(se),{name:i.icon},null,8,["name"])],10,Ye))),128))]),de(_("input",{type:"file",ref_key:"fileRef",ref:r,accept:".json,.txt",onChange:W},null,544),[[re,!1]]),_("div",et,[(B(),D(le,null,ve(E,i=>_("div",{title:i.title,class:Q(["epic-device-item h-90% px-10px flex items-center hover:bg-gray-50 cursor-pointer",{checked:i.key===d.value}]),key:i.key,onClick:J=>Y(i.key)},[O(u(se),{name:i.icon},null,8,["name"])],10,tt)),64))]),_("div",lt,[u(c)?me("",!0):(B(),D("div",nt,[_("div",at,[O(u(x),{value:v.value,"onUpdate:value":t[0]||(t[0]=i=>v.value=i),modelValue:v.value,"onUpdate:modelValue":t[1]||(t[1]=i=>v.value=i),options:n,size:"small"},null,8,["value","modelValue"])]),_("div",ot,[O(u($),{min:.6,max:1.4,step:.01,tooltip:!1,value:u(f),"onUpdate:value":t[2]||(t[2]=i=>be(f)?f.value=i:null),modelValue:u(f),"onUpdate:modelValue":t[3]||(t[3]=i=>be(f)?f.value=i:null)},null,8,["value","modelValue"])])]))])]),O(Xe,{ref_key:"previewJson",ref:w},null,512)],64))}}),st={class:"h-full flex flex-col relative"},ut=["draggable"],ct=H({__name:"editScreenContainer",setup(F){const $=j("pageSchema"),x=R(null),f=R(null),c=R(null),{pressSpace:d,disabledZoom:a}=pe(),{handleElementDragStart:y,handleElementDrag:w,handleElementDragEnd:E}=Ue(x),{width:s,height:h}=De(x),{canvasScale:o,handleZoom:r}=Me(f);let v=0,n=0;const U=R({}),L=R({}),V=R({}),T=Ve({width:0,height:0});G(()=>{var e,t;return{width:(e=$.canvas)==null?void 0:e.width,height:(t=$.canvas)==null?void 0:t.height}},W),G(V,()=>{ye(K)}),we(()=>{var e,t;W({width:(e=$.canvas)==null?void 0:e.width,height:(t=$.canvas)==null?void 0:t.height})});function K(){const e=u(c);e&&(T.value={width:e.clientWidth,height:e.clientHeight})}function W({width:e,height:t}){V.value={width:e!=null?e:"0",height:t!=null?t:"0"}}Pe(s,z),G(T,z);function z(){if(a.value){L.value={width:v+"px",height:n+"px",transform:"translate(0px, 20px)"};return}let e=T.value.width||v,t=T.value.height||n;U.value={width:s.value+e+"px",height:h.value+t+"px"},L.value={width:e+"px",height:t+"px"},Y()}function Y(){ye(()=>{let e=T.value.width||v;const t=(T.value.height||n)/2,i=e/2;x.value.scrollTo(i,t)})}return he(x,([{contentRect:e}])=>{if(v=e.width-60,n=e.height-80,!a.value)if(T.value.width===0)o.value=1;else{const t=(v-20)/T.value.width;o.value=t<1.2?t:o.value}z()}),(e,t)=>(B(),D("div",st,[O(it),_("div",{ref_key:"editScreenContainerRef",ref:x,class:Q(["flex-1 overflow-auto overflow-y-hidden epic-edit-screen-container",{"cursor-grab":u(d)}]),draggable:u(d),onWheel:t[0]||(t[0]=(...i)=>u(r)&&u(r)(...i)),onDragstart:t[1]||(t[1]=(...i)=>u(y)&&u(y)(...i)),onDragend:t[2]||(t[2]=(...i)=>u(E)&&u(E)(...i)),onDrag:t[3]||(t[3]=(...i)=>u(w)&&u(w)(...i))},[_("div",{id:"canvasContainer",class:"flex items-center justify-center",style:ie(U.value)},[_("div",{ref_key:"draggableElRef",ref:f,class:"transition-all"},[_("div",{class:Q({"pointer-events-none":u(d)}),style:ie(L.value)},[Le(e.$slots,"default")],6)],512)],4)],42,ut),_("div",{ref_key:"sizeBoxRef",ref:c,class:"absolute op-0 pointer-events-none",style:ie(V.value)},null,4)]))}}),dt={class:"epic-edit-canvas"},pt=H({__name:"index",setup(F){const $=R(null),x=R(null),f=j("pageSchema"),c=P(()=>f.schemas[0]),d=P(()=>({width:"100%",height:"100%"}));return we(()=>{var a;(a=x.value)==null||a.handleInit($.value)}),(a,y)=>(B(),D("section",dt,[O(ct,null,{default:ae(()=>[_("div",{ref_key:"epicEditRangeRef",ref:$,class:"epic-edit-range rounded-md overflow-auto relative",style:ie(d.value)},[O(Ce,{schema:c.value},null,8,["schema"]),O(He,{ref_key:"ePreviewWidgetsRef",ref:x},null,512)],4)]),_:1})]))}});export{pt as default};
